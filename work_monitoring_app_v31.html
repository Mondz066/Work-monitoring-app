<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Monitoring App</title>

    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme color for browser UI -->
    <meta name="theme-color" content="#111827">
    
    <!-- Apple-specific meta tags for PWA -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/34d399/ffffff?text=✔️">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Work Monitor">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .new-entry { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .summary-box { display: flex; flex-direction: column; justify-content: center; min-height: 90px; text-align: center; }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); }
    </style>
</head>
<body class="bg-black text-gray-200">

    <div class="container mx-auto max-w-2xl p-4 sm:p-6">
        
        <header class="text-center my-6">
            <h1 class="text-3xl font-bold text-white">Work Monitoring Dashboard</h1>
            <p class="text-gray-400 mt-1">Your log is saved automatically to this device.</p>
        </header>

        <div class="bg-gray-900 rounded-xl shadow-md p-6 mb-8 border border-gray-700">
            <form id="log-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="date" name="date" required class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white">
                    </div>
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                        <select id="status" name="status" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white">
                            <option value="Present">Present (Work Day)</option>
                            <option value="Special Holiday (130%)">Special Holiday (130%)</option>
                            <option value="Legal Holiday (200%)">Legal Holiday (200%)</option>
                            <option value="Legal/Special Holiday no work">Legal/Special Holiday no work</option>
                            <option value="Rest Day">Rest Day</option>
                            <option value="Sick Leave">Sick Leave</option>
                            <option value="Leave">Leave (Vacation)</option>
                        </select>
                    </div>
                </div>

                <div id="present-details" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start-time" class="block text-sm font-medium text-gray-300 mb-1">Start Time</label>
                        <input type="time" id="start-time" name="start-time" value="06:00" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white">
                    </div>
                    <div>
                        <label for="end-time" class="block text-sm font-medium text-gray-300 mb-1">End Time</label>
                        <input type="time" id="end-time" name="end-time" value="14:00" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white">
                    </div>
                </div>

                <div class="mt-4">
                    <label for="notes" class="block text-sm font-medium text-gray-300 mb-1">Notes (Optional)</label>
                    <textarea id="notes" name="notes" rows="2" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white" placeholder="e.g., Worked on project X..."></textarea>
                </div>

                <div class="mt-6">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        Add Log Entry
                    </button>
                </div>
            </form>
        </div>
        
        <div class="bg-gray-900 rounded-xl shadow-md p-6 mb-8 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white">Data Management</h2>
            <div class="flex justify-center">
                 <button id="manage-data-btn" class="w-full sm:w-1/2 bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-gray-500">Manage Log Data...</button>
            </div>
        </div>

        <div class="bg-gray-900 rounded-xl shadow-md p-6 mb-8 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white">Summary</h2>
             <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-4">
                 <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs font-semibold text-green-400">Day Shift</p><p id="summary-day-shift" class="text-xl font-bold text-green-300">0.00</p></div>
                 <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs font-semibold text-orange-400">Mid Shift</p><p id="summary-mid-shift" class="text-xl font-bold text-orange-300">0.00</p></div>
                 <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs font-semibold text-blue-400">Night Shift</p><p id="summary-night-shift" class="text-xl font-bold text-blue-300">0.00</p></div>
                 <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs font-semibold text-cyan-400">Overtime</p><p id="summary-overtime-hours" class="text-xl font-bold text-cyan-300">0.00</p></div>
                 <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs font-semibold text-yellow-400">Special Hol. (130%)</p><p id="summary-special-holiday" class="text-xl font-bold text-yellow-300">0.00</p></div>
                 <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs font-semibold text-red-400">Legal Hol. (200%)</p><p id="summary-legal-holiday" class="text-xl font-bold text-red-300">0.00</p></div>
            </div>
            <h2 class="text-xl font-bold mb-4 mt-6 text-white">Days Summary</h2>
            <div id="summary-days-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
        </div>
        
        <div class="bg-gray-900 rounded-xl shadow-md p-6 mb-6 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white">View Past Log History</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label for="month-filter" class="block text-sm font-medium text-gray-300 mb-1">Month</label>
                        <select id="month-filter" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md">
                            <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                            <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                            <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                            <option value="9">October</option><option value="10">November</option><option value="11">December</option>
                        </select>
                    </div>
                    <div>
                        <label for="year-filter" class="block text-sm font-medium text-gray-300 mb-1">Year</label>
                        <select id="year-filter" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md"></select>
                    </div>
                </div>
                <div class="self-end">
                    <button id="apply-filter-btn" class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700">View Month</button>
                </div>
            </div>
        </div>

        <div>
            <div class="flex justify-between items-center mb-4">
                 <h2 id="log-history-title" class="text-2xl font-bold text-white">This Month's Log</h2>
            </div>
            <div id="log-container" class="space-y-3">
                <p id="empty-log-message" class="text-gray-400 text-center py-8 bg-gray-900 rounded-lg border border-gray-700">No entries yet.</p>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal-backdrop" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop">
        <div id="confirm-modal" class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl p-6 w-11/12 max-w-lg mx-auto">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 text-white"></h3>
            <p id="confirm-modal-text" class="text-sm text-gray-400 mb-2"></p>
            <div class="mt-4 flex justify-end gap-3">
                <button id="confirm-modal-cancel" class="bg-gray-600 text-gray-200 font-medium py-2 px-4 rounded-lg hover:bg-gray-500">Cancel</button>
                <button id="confirm-modal-action" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700"></button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal-backdrop" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop">
        <div id="edit-modal" class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl p-6 w-11/12 max-w-lg mx-auto">
            <h3 class="text-xl font-bold mb-6 text-white">Edit Log Entry</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-log-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="edit-date" required class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                    </div>
                    <div>
                        <label for="edit-status" class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                        <select id="edit-status" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                            <option value="Present">Present</option><option value="Special Holiday (130%)">Special Holiday (130%)</option><option value="Legal Holiday (200%)">Legal Holiday (200%)</option><option value="Legal/Special Holiday no work">Legal/Special Holiday no work</option><option value="Rest Day">Rest Day</option><option value="Sick Leave">Sick Leave</option><option value="Leave">Leave</option>
                        </select>
                    </div>
                </div>
                 <div id="edit-present-details" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-start-time" class="block text-sm font-medium text-gray-300 mb-1">Start Time</label>
                        <input type="time" id="edit-start-time" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                    </div>
                    <div>
                        <label for="edit-end-time" class="block text-sm font-medium text-gray-300 mb-1">End Time</label>
                        <input type="time" id="edit-end-time" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="edit-notes" class="block text-sm font-medium text-gray-300 mb-1">Notes</label>
                    <textarea id="edit-notes" rows="3" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-white"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="edit-modal-cancel" class="bg-gray-600 text-gray-200 font-medium py-2 px-4 rounded-lg hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Data Management Modal -->
    <div id="manage-data-modal-backdrop" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop">
        <div id="manage-data-modal" class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl p-6 w-11/12 max-w-lg mx-auto">
            <h3 class="text-xl font-bold mb-6 text-white">Data Management</h3>
            
            <div class="space-y-6">
                <!-- Delete by Month -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-200 mb-3">Delete a Specific Month</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <select id="delete-month-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md"></select>
                        <select id="delete-year-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md"></select>
                        <button id="delete-month-btn" class="w-full bg-red-700/80 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-red-700">Delete Month</button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-600"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-800 text-gray-400">or</span></div></div>
                
                <!-- Delete All Data -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-200 mb-3">Delete All Data</h4>
                    <button id="delete-all-btn" class="w-full bg-red-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-red-500">Wipe All Log Data...</button>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button type="button" id="manage-data-close-btn" class="bg-gray-600 text-gray-200 font-medium py-2 px-4 rounded-lg hover:bg-gray-500">Close</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const elements = {
                // Main form
                logForm: document.getElementById('log-form'), dateInput: document.getElementById('date'),
                statusInput: document.getElementById('status'), presentDetails: document.getElementById('present-details'),
                startTimeInput: document.getElementById('start-time'), endTimeInput: document.getElementById('end-time'),
                notesInput: document.getElementById('notes'),
                // Log display
                logContainer: document.getElementById('log-container'), emptyLogMessage: document.getElementById('empty-log-message'),
                logHistoryTitle: document.getElementById('log-history-title'),
                // Summaries
                summaryDaysContainer: document.getElementById('summary-days-container'),
                summaryDayShift: document.getElementById('summary-day-shift'), summaryMidShift: document.getElementById('summary-mid-shift'),
                summaryNightShift: document.getElementById('summary-night-shift'), summaryOvertime: document.getElementById('summary-overtime-hours'),
                summarySpecialHoliday: document.getElementById('summary-special-holiday'), summaryLegalHoliday: document.getElementById('summary-legal-holiday'),
                // Data Management
                manageDataBtn: document.getElementById('manage-data-btn'),
                // Confirmation Modal
                confirmModalBackdrop: document.getElementById('confirm-modal-backdrop'),
                confirmModalTitle: document.getElementById('confirm-modal-title'), confirmModalText: document.getElementById('confirm-modal-text'),
                confirmModalCancel: document.getElementById('confirm-modal-cancel'), confirmModalAction: document.getElementById('confirm-modal-action'),
                // Edit Modal
                editModalBackdrop: document.getElementById('edit-modal-backdrop'), editForm: document.getElementById('edit-form'),
                editLogId: document.getElementById('edit-log-id'), editDate: document.getElementById('edit-date'),
                editStatus: document.getElementById('edit-status'), editPresentDetails: document.getElementById('edit-present-details'),
                editStartTime: document.getElementById('edit-start-time'), editEndTime: document.getElementById('edit-end-time'),
                editNotes: document.getElementById('edit-notes'), editModalCancel: document.getElementById('edit-modal-cancel'),
                // Filters
                monthFilter: document.getElementById('month-filter'), yearFilter: document.getElementById('year-filter'),
                applyFilterBtn: document.getElementById('apply-filter-btn'),
                // Data Management Modal
                manageDataModalBackdrop: document.getElementById('manage-data-modal-backdrop'),
                deleteMonthSelect: document.getElementById('delete-month-select'),
                deleteYearSelect: document.getElementById('delete-year-select'),
                deleteMonthBtn: document.getElementById('delete-month-btn'),
                deleteAllBtn: document.getElementById('delete-all-btn'),
                manageDataCloseBtn: document.getElementById('manage-data-close-btn'),
            };

            let allLogs = []; 
            const LOGS_STORAGE_KEY = 'workMonitoringAppLogs_v6'; 

            const saveLogs = () => {
                try { localStorage.setItem(LOGS_STORAGE_KEY, JSON.stringify(allLogs)); } 
                catch (error) { console.error("Error saving logs:", error); }
            };

            const loadLogs = () => {
                try {
                    const savedLogs = localStorage.getItem(LOGS_STORAGE_KEY);
                    allLogs = savedLogs ? JSON.parse(savedLogs) : [];
                } catch (error) {
                    console.error("Error loading logs:", error);
                    allLogs = [];
                }
            };

            const getTodayString = () => new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            
            const calculateHours = (start, end) => {
                const startTime = new Date(`1970-01-01T${start}:00`);
                const endTime = new Date(`1970-01-01T${end}:00`);
                let diff = (endTime - startTime) / 3600000;
                if (diff < 0) diff += 24;
                return Math.max(0, diff);
            };

            const updateSummary = (logsToSummarize) => {
                let dayHours = 0, midHours = 0, nightHours = 0, overtimeHours = 0, specialHolidayHours = 0, legalHolidayHours = 0;
                
                logsToSummarize.forEach(log => {
                    if (log.status === 'Present') {
                        overtimeHours += log.overtimeHours || 0;
                        const regularHours = log.regularHours || 0;
                        const startHour = parseInt(log.startTime.split(':')[0]);
                        if (startHour >= 18 || startHour < 6) nightHours += regularHours;
                        else if (startHour >= 14 && startHour < 18) midHours += regularHours;
                        else dayHours += regularHours;
                    } else if (log.status === 'Special Holiday (130%)') {
                        specialHolidayHours += (log.regularHours || 0) + (log.overtimeHours || 0);
                    } else if (log.status === 'Legal Holiday (200%)') {
                        legalHolidayHours += (log.regularHours || 0) + (log.overtimeHours || 0);
                    }
                });

                elements.summaryDayShift.textContent = dayHours.toFixed(2);
                elements.summaryMidShift.textContent = midHours.toFixed(2);
                elements.summaryNightShift.textContent = nightHours.toFixed(2);
                elements.summaryOvertime.textContent = overtimeHours.toFixed(2);
                elements.summarySpecialHoliday.textContent = specialHolidayHours.toFixed(2);
                elements.summaryLegalHoliday.textContent = legalHolidayHours.toFixed(2);
                
                const dayCounts = logsToSummarize.reduce((acc, log) => {
                    switch(log.status) {
                        case 'Present': acc['Present'] = (acc['Present'] || 0) + 1; break;
                        case 'Special Holiday (130%)': acc['Present'] = (acc['Present'] || 0) + 1; break;
                        case 'Legal Holiday (200%)':
                            acc['Present'] = (acc['Present'] || 0) + 1;
                            acc['HolidayWithWork'] = (acc['HolidayWithWork'] || 0) + 1;
                            break;
                        case 'Legal/Special Holiday no work': acc['Holiday'] = (acc['Holiday'] || 0) + 1; break;
                        default: acc[log.status] = (acc[log.status] || 0) + 1; break;
                    }
                    return acc;
                }, {});

                elements.summaryDaysContainer.innerHTML = `
                    <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs text-green-400">Work Days</p><p class="text-xl font-bold text-green-300">${dayCounts['Present'] || 0}</p></div>
                    <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs text-orange-400">Holiday w/work</p><p class="text-xl font-bold text-orange-300">${dayCounts['HolidayWithWork'] || 0}</p></div>
                    <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs text-purple-400">Holidays (no work)</p><p class="text-xl font-bold text-purple-300">${dayCounts['Holiday'] || 0}</p></div>
                    <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs text-blue-400">On Leave</p><p class="text-xl font-bold text-blue-300">${dayCounts['Leave'] || 0}</p></div>
                    <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs text-yellow-400">Sick Days</p><p class="text-xl font-bold text-yellow-300">${dayCounts['Sick Leave'] || 0}</p></div>
                    <div class="summary-box bg-gray-800 p-2 rounded-lg"><p class="text-xs text-gray-400">Rest Days</p><p class="text-xl font-bold text-gray-300">${dayCounts['Rest Day'] || 0}</p></div>`;
            };
            
            const getStatusBadge = (status) => {
                const c = "text-xs font-medium px-2.5 py-1 rounded-full";
                const statuses = {'Sick Leave': `bg-yellow-900/50 text-yellow-300`, 'Leave': `bg-blue-900/50 text-blue-300`, 'Rest Day': `bg-gray-700 text-gray-300`};
                return statuses[status] ? `<span class="${c} ${statuses[status]}">${status}</span>` : '';
            };

            const renderLogs = (logsToRender) => {
                elements.logContainer.innerHTML = '';
                if (logsToRender.length === 0) {
                     if (allLogs.length === 0) {
                        elements.emptyLogMessage.textContent = "No entries yet. Add one above to get started!";
                    } else if (elements.logHistoryTitle.textContent.includes("This Month")) {
                        elements.emptyLogMessage.textContent = "No entries logged for this month.";
                    } else {
                        elements.emptyLogMessage.textContent = "No entries found for this period.";
                    }
                    elements.emptyLogMessage.style.display = 'block';
                } else {
                    elements.emptyLogMessage.style.display = 'none';
                }
                
                logsToRender.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(log => {
                    const el = document.createElement('div');
                    el.className = 'bg-gray-900 rounded-lg shadow-sm p-4 new-entry border border-gray-700';
                    const dayOfWeek = new Date(log.date + 'T00:00:00').toLocaleString('en-US', { weekday: 'short' });
                    let detailsHtml = '', notesHtml = '';
                    const isWorkEntry = ['Present', 'Legal Holiday (200%)', 'Special Holiday (130%)'].includes(log.status);
                    if (isWorkEntry) {
                        const totalHours = (log.regularHours || 0) + (log.overtimeHours || 0);
                        let breakdown = `(${log.regularHours.toFixed(2)} Reg`;
                        if (log.overtimeHours > 0) breakdown += ` + ${log.overtimeHours.toFixed(2)} OT`;
                        breakdown += ')';
                        let badge = '';
                        if(log.status === 'Legal Holiday (200%)') badge = `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-red-900/50 text-red-300">LEGAL 200%</span>`;
                        else if (log.status === 'Special Holiday (130%)') badge = `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-yellow-900/50 text-yellow-300">SPECIAL 130%</span>`;
                        else {
                             const startHour = parseInt(log.startTime.split(':')[0]);
                             if (startHour >= 18 || startHour < 6) badge = `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-blue-900/50 text-blue-300">NIGHT</span>`;
                             else if (startHour >= 14 && startHour < 18) badge = `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-orange-900/50 text-orange-300">MID</span>`;
                             else badge = `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-green-900/50 text-green-300">DAY</span>`;
                        }
                        detailsHtml = `<div class="flex items-center flex-wrap gap-x-3 gap-y-1"><span class="text-sm text-gray-400">${log.startTime} - ${log.endTime}</span><span class="text-lg text-green-400 font-semibold">${totalHours.toFixed(2)} hrs</span><span class="text-xs text-gray-500">${breakdown}</span>${badge}</div>`;
                    } else if (log.status === 'Legal/Special Holiday no work') {
                        detailsHtml = `<div class="flex items-center flex-wrap gap-x-3 gap-y-1"><span class="text-xs font-medium px-2 py-0.5 rounded-full bg-purple-900/50 text-purple-300">PAID HOLIDAY</span></div>`;
                    } else { 
                        detailsHtml = getStatusBadge(log.status); 
                    }
                    if (log.notes) {
                        notesHtml = `<p class="text-sm text-gray-400 mt-2 pl-1 border-l-2 border-gray-700 ml-1">${log.notes.replace(/\n/g, '<br>')}</p>`;
                    }
                    el.innerHTML = `<div class="flex items-start justify-between"><div class="flex-grow"><div class="flex items-baseline gap-3"><p class="font-semibold text-gray-100">${log.date}</p><p class="text-sm text-gray-400">${dayOfWeek}</p></div><div class="mt-1">${detailsHtml}</div>${notesHtml}</div><div class="flex-shrink-0 flex items-center gap-1"><button data-id="${log.id}" class="edit-btn text-gray-500 hover:text-blue-500 p-2 rounded-full"><svg class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"/></svg></button><button data-id="${log.id}" class="delete-btn text-gray-500 hover:text-red-500 p-2 rounded-full"><svg class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></div>`;
                    elements.logContainer.appendChild(el);
                });
                updateSummary(logsToRender);
            };

            const handleStatusChange = (status, detailsEl, startEl, endEl) => {
                const isWorkEntry = ['Present', 'Legal Holiday (200%)', 'Special Holiday (130%)'].includes(status);
                detailsEl.style.display = isWorkEntry ? 'grid' : 'none';
                startEl.required = isWorkEntry;
                endEl.required = isWorkEntry;
            };

            const populateYearFilter = (selectEl) => {
                const currentYear = new Date().getFullYear();
                const years = [...new Set(allLogs.map(log => new Date(log.date).getFullYear()))];
                if (!years.includes(currentYear)) years.push(currentYear);
                years.sort((a,b) => b-a);
                selectEl.innerHTML = years.map(year => `<option value="${year}">${year}</option>`).join('');
            };

            const displayCurrentMonthLogs = () => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                const logsForCurrentMonth = allLogs.filter(log => {
                    const logDate = new Date(log.date + 'T00:00:00');
                    return logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear;
                });
                
                const monthName = now.toLocaleString('default', { month: 'long' });
                elements.logHistoryTitle.textContent = `This Month's Log (${monthName} ${currentYear})`;
                renderLogs(logsForCurrentMonth);
            };
            
            elements.logForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newLog = { 
                    id: Date.now(), date: elements.dateInput.value, status: elements.statusInput.value, 
                    startTime: elements.startTimeInput.value, endTime: elements.endTimeInput.value,
                    notes: elements.notesInput.value.trim(), regularHours: 0, overtimeHours: 0
                };
                const isWorkEntry = ['Present', 'Legal Holiday (200%)', 'Special Holiday (130%)'].includes(newLog.status);
                if (isWorkEntry) {
                    const totalHours = calculateHours(newLog.startTime, newLog.endTime);
                    newLog.regularHours = Math.min(totalHours, 8);
                    newLog.overtimeHours = Math.max(0, totalHours - 8);
                }
                allLogs.push(newLog);
                saveLogs();
                populateYearFilter(elements.yearFilter);
                displayCurrentMonthLogs();
                elements.logForm.reset();
                elements.dateInput.value = getTodayString();
                handleStatusChange(elements.statusInput.value, elements.presentDetails, elements.startTimeInput, elements.endTimeInput);
            });

            elements.logContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const logId = parseInt(deleteBtn.dataset.id);
                    elements.confirmModalTitle.textContent = 'Delete Log Entry';
                    elements.confirmModalText.textContent = 'Are you sure you want to permanently delete this log entry?';
                    elements.confirmModalAction.textContent = 'Delete';
                    elements.confirmModalBackdrop.style.display = 'flex';
                    elements.confirmModalAction.onclick = () => {
                        allLogs = allLogs.filter(log => log.id !== logId);
                        saveLogs();
                        populateYearFilter(elements.yearFilter);
                        displayCurrentMonthLogs();
                        elements.confirmModalBackdrop.style.display = 'none';
                    };
                }

                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) {
                    const logId = parseInt(editBtn.dataset.id);
                    const logToEdit = allLogs.find(log => log.id === logId);
                    if (logToEdit) {
                        elements.editLogId.value = logToEdit.id;
                        elements.editDate.value = logToEdit.date;
                        elements.editStatus.value = logToEdit.status;
                        elements.editStartTime.value = logToEdit.startTime || '';
                        elements.editEndTime.value = logToEdit.endTime || '';
                        elements.editNotes.value = logToEdit.notes || '';
                        handleStatusChange(logToEdit.status, elements.editPresentDetails, elements.editStartTime, elements.editEndTime);
                        elements.editModalBackdrop.style.display = 'flex';
                    }
                }
            });

            elements.editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const logId = parseInt(elements.editLogId.value);
                const logIndex = allLogs.findIndex(log => log.id === logId);
                if (logIndex > -1) {
                    const updatedLog = { ...allLogs[logIndex], date: elements.editDate.value, status: elements.editStatus.value, startTime: elements.editStartTime.value, endTime: elements.editEndTime.value, notes: elements.editNotes.value.trim() };
                    const isWorkEntry = ['Present', 'Legal Holiday (200%)', 'Special Holiday (130%)'].includes(updatedLog.status);
                    if (isWorkEntry) {
                        const totalHours = calculateHours(updatedLog.startTime, updatedLog.endTime);
                        updatedLog.regularHours = Math.min(totalHours, 8);
                        updatedLog.overtimeHours = Math.max(0, totalHours - 8);
                    } else { updatedLog.regularHours = 0; updatedLog.overtimeHours = 0; }
                    allLogs[logIndex] = updatedLog;
                    saveLogs();
                    displayCurrentMonthLogs();
                    elements.editModalBackdrop.style.display = 'none';
                }
            });

            elements.applyFilterBtn.addEventListener('click', () => {
                const month = parseInt(elements.monthFilter.value);
                const year = parseInt(elements.yearFilter.value);
                let filteredLogs = [];
                if (!isNaN(year)) {
                    filteredLogs = allLogs.filter(log => {
                        const logDate = new Date(log.date + 'T00:00:00');
                        return logDate.getMonth() === month && logDate.getFullYear() === year;
                    });
                }
                const monthName = elements.monthFilter.options[elements.monthFilter.selectedIndex].text;
                elements.logHistoryTitle.textContent = `Log for ${monthName} ${year || ''}`;
                renderLogs(filteredLogs);
            });
            
            const closeConfirmModal = () => elements.confirmModalBackdrop.style.display = 'none';
            elements.confirmModalCancel.addEventListener('click', closeConfirmModal);

            const closeEditModal = () => elements.editModalBackdrop.style.display = 'none';
            elements.editModalCancel.addEventListener('click', closeEditModal);

            elements.statusInput.addEventListener('change', () => handleStatusChange(elements.statusInput.value, elements.presentDetails, elements.startTimeInput, elements.endTimeInput));
            elements.editStatus.addEventListener('change', () => handleStatusChange(elements.editStatus.value, elements.editPresentDetails, elements.editStartTime, elements.editEndTime));
            
            // --- Data Management Modal Logic ---
            const populateDeleteMonthYear = () => {
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                const existingDates = new Map();
                allLogs.forEach(log => {
                    const date = new Date(log.date + 'T00:00:00');
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    if(!existingDates.has(year)) existingDates.set(year, new Set());
                    existingDates.get(year).add(month);
                });

                const years = Array.from(existingDates.keys()).sort((a,b) => b-a);
                elements.deleteYearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

                const updateMonths = () => {
                    const selectedYear = parseInt(elements.deleteYearSelect.value);
                    const months = Array.from(existingDates.get(selectedYear) || []).sort((a,b) => a-b);
                    elements.deleteMonthSelect.innerHTML = months.map(m => `<option value="${m}">${monthNames[m]}</option>`).join('');
                };
                elements.deleteYearSelect.addEventListener('change', updateMonths);
                if (years.length > 0) updateMonths();
            };

            elements.manageDataBtn.addEventListener('click', () => {
                populateDeleteMonthYear();
                elements.manageDataModalBackdrop.style.display = 'flex';
            });
            
            elements.manageDataCloseBtn.addEventListener('click', () => elements.manageDataModalBackdrop.style.display = 'none');
            
            elements.deleteAllBtn.addEventListener('click', () => {
                elements.confirmModalTitle.textContent = 'Delete All Log Data';
                elements.confirmModalText.textContent = 'Are you sure you want to permanently delete ALL logs? This cannot be undone.';
                elements.confirmModalAction.textContent = 'Yes, Delete All';
                elements.confirmModalBackdrop.style.display = 'flex';
                elements.confirmModalAction.onclick = () => {
                    allLogs = [];
                    saveLogs();
                    populateYearFilter(elements.yearFilter);
                    displayCurrentMonthLogs();
                    closeConfirmModal();
                    elements.manageDataModalBackdrop.style.display = 'none';
                };
            });

            elements.deleteMonthBtn.addEventListener('click', () => {
                const month = parseInt(elements.deleteMonthSelect.value);
                const year = parseInt(elements.deleteYearSelect.value);
                if(isNaN(month) || isNaN(year)) return;
                
                const monthName = elements.deleteMonthSelect.options[elements.deleteMonthSelect.selectedIndex].text;
                elements.confirmModalTitle.textContent = `Delete Data for ${monthName} ${year}`;
                elements.confirmModalText.textContent = `Are you sure you want to delete all log entries for ${monthName} ${year}? This cannot be undone.`;
                elements.confirmModalAction.textContent = 'Yes, Delete';
                elements.confirmModalBackdrop.style.display = 'flex';
                elements.confirmModalAction.onclick = () => {
                    allLogs = allLogs.filter(log => {
                        const logDate = new Date(log.date + 'T00:00:00');
                        return !(logDate.getMonth() === month && logDate.getFullYear() === year);
                    });
                    saveLogs();
                    populateYearFilter(elements.yearFilter);
                    displayCurrentMonthLogs();
                    closeConfirmModal();
                    elements.manageDataModalBackdrop.style.display = 'none';
                };
            });

            // --- App Initialization ---
            loadLogs();
            elements.dateInput.value = getTodayString();
            elements.monthFilter.value = new Date().getMonth();
            populateYearFilter(elements.yearFilter);
            handleStatusChange(elements.statusInput.value, elements.presentDetails, elements.startTimeInput, elements.endTimeInput);
            displayCurrentMonthLogs();
            
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered.')).catch(err => console.error('SW registration failed:', err));
                });
            }
        });
    </script>
</body>
</html>

